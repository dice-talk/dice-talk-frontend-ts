<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toss Payments</title>
    <script src="https://js.tosspayments.com/v2/payment-widget"></script>
    <style>
        /* 화면에 아무것도 안보이는 경우를 대비하여 payment-method 영역 확인용 스타일 */
        #payment-method {
            min-height: 100px; /* 최소 높이 지정 */
            border: 1px solid #eee; /* 테두리 추가 */
            padding: 10px;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="payment-method"></div>
    <!-- 결제하기 버튼은 자동 실행되므로 필요 없어 보입니다. -->
    <!-- <button id="payment-button" style="display:none;">결제하기</button> -->

    <script>
        let paymentData = null;
        let isTossScriptLoaded = false;

        /* [수정] RN에서 호출할 함수: 전달받은 결제 정보를 저장하고, 스크립트가 이미 로드되었다면 위젯 렌더링을 시작합니다. */
        window.initializePayment = function(paymentDetailsString) {
            console.log('[WebView] initializePayment function called.');
            try {
                paymentData = JSON.parse(paymentDetailsString);
                console.log('[WebView] Parsed payment details:', paymentData);

                if (isTossScriptLoaded) {
                    console.log('[WebView] Toss script was already loaded. Rendering widget now.');
                    renderWidget();
                } else {
                    console.log('[WebView] Toss script not loaded yet. Waiting for onload event.');
                }
            } catch (e) {
                console.error('[WebView] Error parsing paymentDetailsString or in initializePayment:', e);
                sendMessageToReactNative({
                    type: 'ERROR',
                    payload: { message: 'WebView에서 결제정보 처리 중 오류 발생', error: e.toString() }
                });
            }
        };

        /* [추가] 토스 스크립트의 onload 이벤트에서 호출될 함수: 스크립트 로딩 완료를 기록하고, 결제 정보가 이미 도착했다면 위젯 렌더링을 시작합니다. */
        function onTossScriptReady() {
            console.log('[WebView] Toss script is now loaded.');
            isTossScriptLoaded = true;
            if (paymentData) {
                console.log('[WebView] Payment data was already received. Rendering widget now.');
                renderWidget();
            }
        }
        
        /* [수정] 위젯 렌더링 및 결제 요청 로직을 별도 함수로 분리 */
        async function renderWidget() {
             // 두 조건이 모두 충족되지 않으면 실행하지 않음
            if (!paymentData || !isTossScriptLoaded) {
                console.warn('[WebView] renderWidget called, but conditions not met.');
                return;
            }

            const clientKey = paymentData.clientKey;
            const customerKey = paymentData.customerKey;
            const amount = paymentData.amount;
            
            console.log('[WebView] Initializing PaymentWidget with clientKey:', clientKey, 'customerKey:', customerKey);

            try {
                const paymentWidget = PaymentWidget(clientKey, customerKey || PaymentWidget.ANONYMOUS);
                
                await paymentWidget.renderPaymentMethods("#payment-method", { value: amount }, { variantKey: "DEFAULT" });
                console.log('[WebView] renderPaymentMethods Succeeded. Requesting payment...');

                await paymentWidget.requestPayment(paymentData);

            } catch (error) {
                console.error('[WebView] Error in renderWidget:', error);
                sendMessageToReactNative({ type: 'ERROR', payload: { message: '결제 UI 렌더링 또는 초기화 실패', errorName: error.name, errorMessage: error.message }});
            }
        }

        // 기존의 sendMessageToReactNative, initializePaymentWidget, requestTossPayment 함수들은
        // 위의 renderWidget 함수로 통합되었으므로, 여기서는 제거하거나 주석 처리합니다.
    </script>
    <!-- [수정] 토스 스크립트 태그에 onload 콜백을 추가합니다. -->
    <script src="https://js.tosspayments.com/v2/payment-widget" onload="onTossScriptReady()"></script>
</body>
</html>