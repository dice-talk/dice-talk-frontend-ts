<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toss Payments</title>
    <!-- 사용자가 제공한 공식 문서 버전인 v1 스크립트를 사용합니다. -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <style>
        /* 화면에 아무것도 안보이는 경우를 대비하여 payment-method 영역 확인용 스타일 */
        #payment-method {
            min-height: 100px; /* 최소 높이 지정 */
            border: 1px solid #eee; /* 테두리 추가 */
            padding: 10px;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #payment-method, #agreement { width: 100%; }
    </style>
</head>
<body>
    <div id="payment-method"></div>
    <div id="agreement"></div>
    <!-- 결제하기 버튼은 자동 실행되므로 필요 없어 보입니다. -->
    <!-- <button id="payment-button" style="display:none;">결제하기</button> -->

    <script>
        // 전역 변수로 위젯과 결제 정보를 저장합니다.
        let paymentWidget = null;
        let paymentData = null;

        /**
         * 디버깅 및 오류 메시지를 React Native로 전송하는 헬퍼 함수
         */
        function sendMessageToReactNative(message) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(message));
            }
        }

        /**
         * React Native에서 호출할 함수: 위젯을 렌더링합니다.
         */
        window.renderWidget = async function(paymentDetailsString) {
            sendMessageToReactNative({ type: 'LOG', payload: 'WebView: renderWidget 함수 호출됨.' });
            try {
                paymentData = JSON.parse(paymentDetailsString);
                
                // 1. 위젯 초기화 (고객 키는 비회원일 경우를 대비하여 ANONYMOUS 처리)
                paymentWidget = PaymentWidget(paymentData.clientKey, paymentData.customerKey || PaymentWidget.ANONYMOUS);
                
                // 2. 결제 UI 렌더링
                await paymentWidget.renderPaymentMethods(
                    "#payment-method", 
                    { value: paymentData.amount },
                    { variantKey: "DEFAULT" }
                );

                // 3. 약관 UI 렌더링
                await paymentWidget.renderAgreement("#agreement", { variantKey: "AGREEMENT" });

                sendMessageToReactNative({ type: 'LOG', payload: 'WebView: 위젯 렌더링 성공.' });
                // 4. React Native에 위젯 준비 완료 신호 전송
                sendMessageToReactNative({ type: 'WIDGET_READY' });

            } catch (error) {
                sendMessageToReactNative({ type: 'ERROR', payload: { message: '결제 위젯 렌더링 실패: ' + error.message } });
            }
        };

        /**
         * React Native에서 호출할 함수: 결제를 요청합니다.
         */
        window.startPayment = async function() {
            sendMessageToReactNative({ type: 'LOG', payload: 'WebView: startPayment 함수 호출됨.' });
            if (paymentWidget && paymentData) {
                try {
                    await paymentWidget.requestPayment(paymentData);
                } catch (error) {
                    sendMessageToReactNative({ type: 'ERROR', payload: { message: '결제 요청 실패: ' + error.message } });
                }
            } else {
                sendMessageToReactNative({ type: 'ERROR', payload: { message: '결제 위젯이 준비되지 않았습니다.' } });
            }
        };

        // 페이지가 로드되었음을 초기에 한번 알립니다.
        sendMessageToReactNative({ type: 'HTML_LOADED' });
    </script>
</body>
</html>