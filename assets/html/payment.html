<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toss Payment Widget</title>
    <!-- 사용자가 제공한 공식 문서 버전인 v1 스크립트를 사용합니다. -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <style>
        /* 화면에 아무것도 안보이는 경우를 대비하여 payment-method 영역 확인용 스타일 */
        #payment-method {
            min-height: 100px; /* 최소 높이 지정 */
            border: 1px solid #eee; /* 테두리 추가 */
            padding: 10px;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #payment-method, #agreement { width: 100%; }
    </style>
</head>
<body>
    <!-- 결제 UI가 렌더링될 영역 -->
    <div id="payment-method"></div>
    <!-- 이용약관 UI가 렌더링될 영역 -->
    <div id="agreement"></div>

    <script>
        // let paymentWidget;
        // let paymentMethodWidget;
        const widgetClientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        const customerKey = "jgEwseWGELD7bBy-mCBdV";
        paymentWidget = PaymentWidget(widgetClientKey, customerKey); // 회원 결제
        // const paymentWidget = PaymentWidget(widgetClientKey, PaymentWidget.ANONYMOUS) // 비회원 결제

        // React Native로부터 메시지를 수신하고 JSON으로 파싱하는 헬퍼 함수
        const postMessage = (data) => {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(data));
            }
        };

        // 로그 전송용 함수
        const log = (payload) => postMessage({ type: 'LOG', payload });

        // 위젯 렌더링 함수: React Native에서 호출됩니다.
        window.renderWidget = (paymentDetailsJSON) => {
            try {
                log('renderWidget called with: ' + paymentDetailsJSON);
                const paymentDetails = JSON.parse(paymentDetailsJSON);
                const { clientKey, customerKey, amount } = paymentDetails;

                if (!clientKey || !customerKey || !amount) {
                    throw new Error('필수 결제 정보(clientKey, customerKey, amount)가 누락되었습니다.');
                }

                // 1. 결제 위젯 초기화
                paymentWidget = PaymentWidget(clientKey, customerKey);

                // 2. 결제 UI 렌더링
                paymentMethodWidget = paymentWidget.renderPaymentMethods(
                    '#payment-method', 
                    { value: amount },
                    { variantKey: 'DEFAULT' } // variantKey는 필요에 따라 변경
                );
                
                // 3. 이용약관 UI 렌더링
                paymentWidget.renderAgreement('#agreement', { variantKey: 'AGREEMENT' });

                // 4. 위젯 렌더링 완료 신호 전송
                postMessage({ type: 'WIDGET_READY' });
                log('Widget rendering finished.');

            } catch (error) {
                log('Error in renderWidget: ' + error.message);
                postMessage({ type: 'ERROR', payload: { message: error.message } });
            }
        };

        // 결제 요청 함수: React Native에서 호출됩니다.
        window.startPayment = () => {
            try {
                log('startPayment called');
                const paymentDetails = JSON.parse(window.paymentDetailsString); // 저장된 정보 사용

                if (!paymentWidget) {
                    throw new Error('결제 위젯이 초기화되지 않았습니다.');
                }

                // 결제 요청
                paymentWidget.requestPayment({
                    orderId: paymentDetails.orderId,
                    orderName: paymentDetails.orderName,
                    successUrl: paymentDetails.successUrl,
                    failUrl: paymentDetails.failUrl,
                    // 필요에 따라 고객 정보 추가
                    // customerEmail: paymentDetails.customerEmail,
                    // customerName: paymentDetails.customerName,
                });

            } catch (error) {
                log('Error in startPayment: ' + error.message);
                postMessage({ type: 'ERROR', payload: { message: error.message } });
            }
        };
        
        // 결제 요청에 필요한 정보를 전역 변수에 저장해두기 위한 트릭
        // renderWidget 함수는 호출 시 인자를 받지만, startPayment는 인자 없이 호출되므로
        // renderWidget 시점에 정보를 저장해둡니다.
        Object.defineProperty(window, 'paymentDetailsString', {
            value: '{}',
            writable: true,
        });
        const originalRenderWidget = window.renderWidget;
        window.renderWidget = (detailsJSON) => {
            window.paymentDetailsString = detailsJSON;
            originalRenderWidget(detailsJSON);
        };

    </script>
</body>
</html>